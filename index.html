<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gerenciador SG Multimídia</title>
    <!-- Manifesto do PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8257e5">
    
    <!-- Fontes e Ícones -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <style>
        :root {
            --bg-body: #121214;
            --bg-sidebar: #202024;
            --bg-card: #29292e;
            --bg-modal: #202024;
            --text-primary: #e1e1e6;
            --text-secondary: #a8a8b3;
            --primary: #8257e5;
            --primary-hover: #9466ff;
            --danger: #e57878;
            --success: #04d361;
            --warning: #fba94c;
            --border: #323238;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--text-primary); display: flex; height: 100vh; overflow: hidden; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

        aside { width: 250px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; overflow-y: auto; }
        aside h2 { color: var(--primary); margin-bottom: 30px; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        
        nav button {
            background: none; border: none; color: var(--text-secondary); width: 100%; text-align: left;
            padding: 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 0.95rem;
            display: flex; align-items: center; gap: 12px; margin-bottom: 5px;
        }
        nav button:hover, nav button.active { background-color: var(--bg-card); color: var(--primary); }
        nav button i { width: 20px; text-align: center; }

        main { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        
        section { display: none; animation: fadeIn 0.3s ease; }
        section.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1 { font-size: 1.8rem; margin-bottom: 20px; font-weight: 600; }
        h3 { font-size: 1.2rem; margin-bottom: 15px; color: var(--text-primary); }

        .btn {
            padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500;
            display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 0.9rem; text-decoration: none;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-success { background-color: var(--success); color: #000; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

        .card { background-color: var(--bg-card); border-radius: 8px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; background-color: var(--bg-body); border: 1px solid var(--border); color: var(--text-primary);
            padding: 10px; border-radius: 6px; outline: none;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--primary); }
        .form-group input[type="file"] { padding: 6px; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); vertical-align: middle; }
        th { color: var(--text-secondary); font-weight: 500; font-size: 0.9rem; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .badge-pending { background-color: rgba(251, 169, 76, 0.2); color: var(--warning); }
        .badge-approved { background-color: rgba(4, 211, 97, 0.2); color: var(--success); }

        /* Kanban */
        .kanban-board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; height: calc(100vh - 150px); }
        .kanban-column { background-color: var(--bg-sidebar); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; border: 1px solid var(--border); }
        .kanban-header { font-weight: 600; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .kanban-body { flex: 1; overflow-y: auto; }
        .project-card { background-color: var(--bg-card); padding: 15px; border-radius: 6px; margin-bottom: 10px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .project-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .project-card h4 { margin-bottom: 5px; font-size: 0.95rem; }
        .project-card p { color: var(--text-secondary); font-size: 0.8rem; }

        /* Calendário */
        .calendar-wrapper { display: flex; gap: 20px; height: calc(100vh - 150px); }
        .calendar-main { flex: 2; display: flex; flex-direction: column; }
        .calendar-sidebar { flex: 1; overflow-y: auto; padding-right: 10px; }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .cal-day-name { text-align: center; color: var(--text-secondary); font-size: 0.8rem; padding: 10px 0; }
        .cal-day { 
            background-color: var(--bg-sidebar); min-height: 80px; padding: 8px; border-radius: 6px; cursor: pointer; 
            border: 1px solid transparent; transition: 0.2s; display: flex; flex-direction: column; gap: 4px;
        }
        .cal-day:hover { border-color: var(--primary); background-color: #29292e; }
        .cal-day.today { border-color: var(--primary); background-color: rgba(130, 87, 229, 0.1); }
        .cal-day-number { font-weight: 600; font-size: 0.9rem; }
        .cal-event-dot { 
            font-size: 0.65rem; background: var(--primary); color: white; padding: 2px 4px; border-radius: 3px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }

        /* Modais */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-overlay.open { display: flex; }
        .modal {
            background-color: var(--bg-modal); width: 90%; max-width: 650px; max-height: 90vh; overflow-y: auto;
            border-radius: 8px; padding: 25px; position: relative; border: 1px solid var(--border);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-modal { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem; }
        
        .budget-items-table { font-size: 0.85rem; margin-bottom: 15px; }
        .budget-items-table th, .budget-items-table td { padding: 8px; }
        
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background-color: var(--bg-card); border-left: 4px solid var(--primary); padding: 15px 20px;
            border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px;
            animation: slideIn 0.3s ease; width: 300px;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            aside { width: 100%; border-right: none; border-bottom: 1px solid var(--border); }
            .kanban-board { grid-template-columns: 1fr; height: auto; }
            .calendar-wrapper { flex-direction: column; height: auto; }
        }
    </style>
</head>
<body>

<!-- INÍCIO DA TRAVA DE SEGURANÇA -->
<div id="lock-screen" style="position:fixed; top:0; left:0; width:100%; height:100%; background-color:var(--bg-body); z-index:99999; display:flex; flex-direction:column; justify-content:center; align-items:center;">
    <div style="text-align:center;">
        <h2 style="color:var(--primary); margin-bottom:20px;">Acesso Restrito</h2>
        <p style="margin-bottom:20px; color:var(--text-secondary);">Digite a senha para acessar o Gerenciador SG Multimídia</p>
        <input type="password" id="pass-input" placeholder="Senha" style="padding:15px; border-radius:8px; border:1px solid var(--border); background:var(--bg-card); color:white; font-size:1.1rem; text-align:center;">
        <button onclick="checkPassword()" style="margin-top:20px; padding:10px 30px; font-size:1rem;">Entrar</button>
    </div>
</div>

<!-- Esconde o conteúdo principal inicialmente -->
<style id="lock-css">
    aside, main, #toast-container { display: none !important; }
    body { overflow: hidden; } /* Impede rolagem para não ver o que está atrás */
</style>
<!-- FIM DA TRAVA DE SEGURANÇA -->

    <aside>
        <h2><i class="fas fa-film"></i> Gerenciador SG</h2>
        <nav>
            <button onclick="app.navigate('dashboard')" class="active"><i class="fas fa-chart-line"></i> Dashboard</button>
            <button onclick="app.navigate('services')"><i class="fas fa-tags"></i> Serviços & Combos</button>
            <button onclick="app.navigate('clients')"><i class="fas fa-users"></i> Clientes</button>
            <button onclick="app.navigate('budgets')"><i class="fas fa-file-invoice-dollar"></i> Orçamentos</button>
            <button onclick="app.navigate('projects')"><i class="fas fa-tasks"></i> Projetos</button>
            <button onclick="app.navigate('finance')"><i class="fas fa-wallet"></i> Financeiro</button>
            <button onclick="app.navigate('calendar')"><i class="fas fa-calendar-alt"></i> Agenda</button>
            <button onclick="app.navigate('contracts')"><i class="fas fa-file-contract"></i> Contratos</button>
        </nav>
    </aside>

    <main>
        <div id="toast-container"></div>
        <div id="print-area" style="display:none; padding: 40px; background: white; color: black;"></div>

        <!-- DASHBOARD -->
        <section id="dashboard" class="active">
            <h1>Visão Geral</h1>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div class="card stat-card"><p>Projetos Ativos</p><h3 id="dash-active-projects">0</h3></div>
                <div class="card stat-card"><p>Faturamento (Mês)</p><h3 id="dash-revenue" style="color:var(--success)">R$ 0,00</h3></div>
                <div class="card stat-card"><p>Orçamentos Pendentes</p><h3 id="dash-pending-budgets">0</h3></div>
            </div>
            <div class="card">
                <h3><i class="fas fa-bullhorn"></i> Ações Rápidas</h3>
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="app.prepareAddClient()">Novo Cliente</button>
                    <button class="btn btn-primary" onclick="app.openModalBudget()">Novo Orçamento</button>
                    <button class="btn btn-outline" onclick="app.selectDate(new Date().toISOString().split('T')[0])">Agendar Hoje</button>
                </div>
            </div>
        </section>

        <!-- SERVIÇOS E COMBOS -->
        <section id="services">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1>Serviços & Combos</h1>
            </div>
            
            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <h3>Serviços Individuais</h3>
                    <button class="btn btn-primary btn-sm" onclick="app.openModalService()"><i class="fas fa-plus"></i> Novo Serviço</button>
                </div>
                <table id="table-services">
                    <thead><tr><th>Nome</th><th>Unidade</th><th>Preço</th><th>Ações</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <h3>Pacotes (Combos)</h3>
                    <button class="btn btn-primary btn-sm" onclick="app.openModalCombo()"><i class="fas fa-layer-group"></i> Novo Combo</button>
                </div>
                <table id="table-combos">
                    <thead><tr><th>Nome do Pacote</th><th>Itens Incluídos</th><th>Preço Total</th><th>Ações</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- CLIENTES -->
        <section id="clients">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1>Carteira de Clientes</h1>
                <button class="btn btn-primary" onclick="app.prepareAddClient()"><i class="fas fa-plus"></i> Novo Cliente</button>
            </div>
            <div class="card">
                <table id="table-clients">
                    <thead><tr><th>Nome</th><th>Tipo</th><th>Doc</th><th>Contato</th><th>Ações</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- ORÇAMENTOS -->
        <section id="budgets">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap:10px;">
                <h1>Orçamentos</h1>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="search-budget" placeholder="Buscar..." style="padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-primary);">
                    <button class="btn btn-primary" onclick="app.openModalBudget()"><i class="fas fa-plus"></i> Novo</button>
                </div>
            </div>
            <div class="card">
                <table id="table-budgets">
                    <thead><tr><th>ID</th><th>Cliente</th><th>Resumo dos Itens</th><th>Valor</th><th>Status</th><th>Ações</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- PROJETOS -->
        <section id="projects">
            <h1>Acompanhamento de Projetos</h1>
            <div class="kanban-board">
                <div class="kanban-column" id="col-not-started">
                    <div class="kanban-header">Não Iniciado <span class="badge badge-pending" id="count-not-started">0</span></div>
                    <div class="kanban-body" id="list-not-started"></div>
                </div>
                <div class="kanban-column" id="col-in-progress">
                    <div class="kanban-header">Em Andamento <span class="badge badge-approved" id="count-in-progress">0</span></div>
                    <div class="kanban-body" id="list-in-progress"></div>
                </div>
                <div class="kanban-column" id="col-completed">
                    <div class="kanban-header">Concluído <span class="badge" style="background:#444; color:#fff" id="count-completed">0</span></div>
                    <div class="kanban-body" id="list-completed"></div>
                </div>
                <div class="kanban-column" id="col-cancelled">
                    <div class="kanban-header">Cancelado <span class="badge badge-rejected" id="count-cancelled">0</span></div>
                    <div class="kanban-body" id="list-cancelled"></div>
                </div>
            </div>
        </section>

        <!-- FINANCEIRO -->
        <section id="finance">
            <h1>Gestão Financeira</h1>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div class="card stat-card"><p>Entradas</p><h3 id="fin-total-in" style="color:var(--success)">R$ 0,00</h3></div>
                <div class="card stat-card"><p>Saídas</p><h3 id="fin-total-out" style="color:var(--danger)">R$ 0,00</h3></div>
                <div class="card stat-card"><p>Saldo em Caixa</p><h3 id="fin-balance">R$ 0,00</h3></div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                <!-- Controle MEI -->
                <div class="card">
                    <h3><i class="fas fa-user-tie"></i> Planejamento MEI</h3>
                    <div class="form-group">
                        <label>Saldo Atual Disponível</label>
                        <input type="text" id="mei-cash-avail" value="R$ 0,00" disabled style="background:#121214">
                    </div>
                    <div class="form-group">
                        <label>% para Retirada (Pró-labore)</label>
                        <input type="number" id="mei-perc" value="10" oninput="app.updateWithdrawal()">
                    </div>
                    <div class="card" style="background: rgba(130, 87, 229, 0.1); border-color: var(--primary); text-align: center;">
                        <p>Retirada Sugerida (Mensal)</p>
                        <h2 id="mei-withdrawal-val" style="color: var(--primary);">R$ 0,00</h2>
                    </div>
                </div>

                <!-- Transações -->
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <h3>Movimentações</h3>
                        <div>
                            <button class="btn btn-sm btn-success" onclick="app.openModal('modal-transaction', 'in')">+ Receita</button>
                            <button class="btn btn-sm btn-danger" onclick="app.openModal('modal-transaction', 'out')">- Despesa</button>
                        </div>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table id="table-transactions">
                            <thead><tr><th>Data</th><th>Cliente/Desc</th><th>Cat</th><th>Valor</th><th>Ação</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- AGENDA -->
        <section id="calendar">
            <h1>Agenda de Compromissos</h1>
            <div class="calendar-wrapper">
                <div class="calendar-main">
                    <div class="card">
                        <div class="cal-header">
                            <button class="btn btn-sm btn-outline" onclick="app.changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                            <h3 id="cal-month-year"></h3>
                            <button class="btn btn-sm btn-outline" onclick="app.changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="cal-grid">
                            <div class="cal-day-name">Dom</div><div class="cal-day-name">Seg</div><div class="cal-day-name">Ter</div>
                            <div class="cal-day-name">Qua</div><div class="cal-day-name">Qui</div><div class="cal-day-name">Sex</div><div class="cal-day-name">Sáb</div>
                        </div>
                        <div id="cal-days" class="cal-grid"></div>
                    </div>
                </div>
                <div class="calendar-sidebar">
                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 20px;" onclick="app.selectDate(new Date().toISOString().split('T')[0])">Novo Agendamento</button>
                    <div class="card">
                        <h4>Próximos Eventos</h4>
                        <div id="schedule-list" style="display:flex; flex-direction:column; gap:10px; margin-top:10px;"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- CONTRATOS -->
        <section id="contracts">
            <h1>Central de Contratos</h1>
            <div class="card">
                <p>Contratos são gerados automaticamente a partir de orçamentos aprovados.</p>
                <br>
                <table id="table-contracts">
                    <thead><tr><th>Projeto</th><th>Cliente</th><th>Baixar</th></tr></thead>
                    <tbody><!-- JS --></tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- MODAL SERVIÇO -->
    <div id="modal-service" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Novo Serviço</h3>
                <button class="close-modal" onclick="app.closeModal('modal-service')">&times;</button>
            </div>
            <form onsubmit="app.saveService(event)">
                <input type="hidden" id="service-id">
                <div class="form-group"><label>Nome do Serviço</label><input type="text" id="service-name" required></div>
                <div class="form-group">
                    <label>Unidade de Cobrança</label>
                    <select id="service-unit">
                        <option value="hour">Por Hora</option>
                        <option value="track">Por Faixa</option>
                        <option value="image">Por Imagem</option>
                        <option value="video">Por Vídeo</option>
                    </select>
                </div>
                <div class="form-group"><label>Preço Individual (R$)</label><input type="number" id="service-price" step="0.01" required></div>
                <div class="form-group"><label>Descrição</label><textarea id="service-desc"></textarea></div>
                <button type="submit" class="btn btn-primary" style="width:100%">Salvar</button>
            </form>
        </div>
    </div>

    <!-- MODAL COMBO -->
    <div id="modal-combo" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Novo Pacote (Combo)</h3>
                <button class="close-modal" onclick="app.closeModal('modal-combo')">&times;</button>
            </div>
            <form onsubmit="app.saveCombo(event)">
                <input type="hidden" id="combo-id">
                <div class="form-group"><label>Nome do Pacote</label><input type="text" id="combo-name" required></div>
                <div class="form-group"><label>Descrição</label><textarea id="combo-desc"></textarea></div>
                <div class="form-group">
                    <label>Selecione os Serviços</label>
                    <div id="combo-services-list" style="max-height: 150px; overflow-y: auto; background: var(--bg-body); padding: 10px; border-radius: 6px; border: 1px solid var(--border);"></div>
                </div>
                <div class="card" style="background: rgba(4, 211, 97, 0.1); border-color: var(--success); text-align: center;">
                    <p>Preço Total do Pacote</p>
                    <h3 id="combo-preview-price">R$ 0,00</h3>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%; margin-top:15px">Criar Combo</button>
            </form>
        </div>
    </div>

    <!-- MODAL CLIENTE -->
    <div id="modal-client" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-client-title">Novo Cliente</h3>
                <button class="close-modal" onclick="app.closeModal('modal-client')">&times;</button>
            </div>
            <form onsubmit="app.saveClient(event)">
                <input type="hidden" id="client-id">
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="client-type" onchange="app.toggleClientDoc()">
                        <option value="pf">Pessoa Física</option>
                        <option value="pj">Pessoa Jurídica</option>
                    </select>
                </div>
                <div class="form-group"><label>Nome</label><input type="text" id="client-name" required></div>
                <div class="form-group"><label id="label-doc">CPF</label><input type="text" id="client-doc" oninput="app.maskDocument(this)"></div>
                <div class="form-group"><label>E-mail</label><input type="email" id="client-email"></div>
                <div class="form-group"><label>Telefone</label><input type="text" id="client-phone" oninput="app.maskPhone(this)"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%">Salvar</button>
            </form>
        </div>
    </div>

    <!-- MODAL ORÇAMENTO -->
    <div id="modal-budget" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Novo Orçamento</h3>
                <button class="close-modal" onclick="app.closeModal('modal-budget')">&times;</button>
            </div>
            <form onsubmit="app.saveBudget(event)">
                <div class="form-group">
                    <label>Cliente</label>
                    <select id="budget-client" required></select>
                </div>
                
                <!-- Área de Adicionar Itens -->
                <div style="background: var(--bg-body); padding: 15px; border-radius: 6px; border: 1px solid var(--border); margin-bottom: 15px;">
                    <label style="display:block; margin-bottom:5px;">Adicionar Serviço ou Combo</label>
                    <div style="display:flex; gap:10px;">
                        <select id="budget-item-select" style="flex:2"></select>
                        <button type="button" class="btn btn-primary" onclick="app.addItemToBudget()">Adicionar</button>
                    </div>
                </div>

                <!-- Tabela de Itens Selecionados -->
                <div style="margin-bottom: 15px;">
                    <table class="budget-items-table">
                        <thead><tr><th>Item</th><th>Preço</th><th>Ação</th></tr></thead>
                        <tbody id="budget-items-tbody"></tbody>
                    </table>
                    <p id="empty-budget-msg" style="text-align:center; color:var(--text-secondary); font-size:0.9rem;">Nenhum item adicionado</p>
                </div>

                <div class="form-group">
                    <label>Desconto Global</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="budget-discount-type" style="width: 80px" onchange="app.calculateBudgetTotal()">
                            <option value="perc">%</option>
                            <option value="fixed">R$</option>
                        </select>
                        <input type="number" id="budget-discount-val" value="0" min="0" oninput="app.calculateBudgetTotal()">
                    </div>
                </div>
                <div class="card" style="background: rgba(4, 211, 97, 0.1); border-color: var(--success); margin-bottom:15px; text-align:center;">
                    <p>Valor Final</p>
                    <h2 id="budget-final-val">R$ 0,00</h2>
                </div>
                <div class="form-group"><label>Obs</label><textarea id="budget-notes"></textarea></div>
                <button type="submit" class="btn btn-primary" style="width: 100%">Gerar Orçamento</button>
            </form>
        </div>
    </div>

    <!-- MODAL TRANSAÇÃO -->
    <div id="modal-transaction" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="trans-title">Nova Transação</h3>
                <button class="close-modal" onclick="app.closeModal('modal-transaction')">&times;</button>
            </div>
            <form onsubmit="app.saveTransaction(event)">
                <input type="hidden" id="trans-type">
                <div class="form-group"><label>Cliente (Opcional)</label><select id="trans-client"><option value="">Sem cliente específico</option></select></div>
                <div class="form-group"><label>Descrição</label><input type="text" id="trans-desc" required></div>
                <div class="form-group"><label>Categoria</label><select id="trans-cat"></select></div>
                <div class="form-group"><label>Valor</label><input type="number" id="trans-val" step="0.01" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%">Salvar</button>
            </form>
        </div>
    </div>

    <!-- MODAL AGENDAMENTO -->
    <div id="modal-schedule" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="sched-modal-title">Novo Agendamento</h3>
                <button class="close-modal" onclick="app.closeModal('modal-schedule')">&times;</button>
            </div>
            <form onsubmit="app.saveSchedule(event)">
                <input type="hidden" id="sched-id">
                <div class="form-group"><label>Cliente</label><select id="sched-client" required></select></div>
                <div class="form-group"><label>Serviço</label><select id="sched-service" required><option value="Reunião">Reunião</option><option value="Gravação">Gravação</option><option value="Edição">Edição</option></select></div>
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex:1"><label>Data</label><input type="date" id="sched-date" required></div>
                    <div class="form-group" style="flex:1"><label>Hora</label><input type="time" id="sched-time" required></div>
                </div>
                <div class="form-group"><label>Duração (h)</label><input type="number" id="sched-duration" value="1"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%">Salvar</button>
            </form>
        </div>
    </div>

    <!-- Modal Detalhes Projeto -->
    <div id="modal-project-details" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Gerenciar Projeto</h3>
                <button class="close-modal" onclick="app.closeModal('modal-project-details')">&times;</button>
            </div>
            <div id="project-details-content"></div>
        </div>
    </div>

    <script>
        // =================================================================
        // CONFIGURAÇÃO DO FIREBASE
        // =================================================================
        // Lembre-se de colar suas chaves aqui!
        const firebaseConfig = {
  apiKey: "AIzaSyCqiuHQcfNeLbURK7XjEFrEBnD2G0TH_6A",
  authDomain: "banco-de-dados-do-gerenciador.firebaseapp.com",
  projectId: "banco-de-dados-do-gerenciador",
  storageBucket: "banco-de-dados-do-gerenciador.firebasestorage.app",
  messagingSenderId: "973677858372",
  appId: "1:973677858372:web:3dcbe72ffa5ab20d663611",
  measurementId: "G-C59X29PXWX"
};

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const storage = firebase.storage();

        // =================================================================
        // UTILITÁRIOS
        // =================================================================
        const Utils = {
            formatCurrency(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v); },
            formatDate(s) { if(!s) return '-'; const [y,m,d] = s.split('-'); return `${d}/${m}/${y}`; },
            parseCurrency(str) {
                if(!str) return 0;
                let clean = str.replace('R$ ', '').replace(/\./g, '').replace(',', '.');
                return parseFloat(clean) || 0;
            },
            generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        };

        // =================================================================
        // STORE & FIREBASE INTEGRAÇÃO
        // =================================================================
        const Store = {
            data: {
                clients: [],
                budgets: [],
                projects: [],
                transactions: [],
                schedules: [],
                services: [],
                combos: []
            },
            currentDate: new Date(),
            
            async init() {
                try {
                    const collections = ['clients', 'budgets', 'projects', 'transactions', 'schedules', 'services', 'combos'];
                    const promises = collections.map(col => db.collection(col).get());
                    const snapshots = await Promise.all(promises);

                    snapshots.forEach((snap, index) => {
                        const colName = collections[index];
                        Store.data[colName] = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    });

                    app.renderAll();
                    app.showToast("Sincronizado com Firebase", "success");
                } catch (error) {
                    console.error("Erro ao carregar dados:", error);
                    app.showToast("Erro ao carregar dados. Verifique a Configuração do Firebase.", "danger");
                }
            },

            async add(collection, item) {
                if(!item.id) item.id = Utils.generateId();
                const { id, ...data } = item;
                await db.collection(collection).doc(id).set(data);
                Store.data[collection].push(item); 
                return item;
            },
            
            async update(collection, id, item) {
                const { id: _, ...data } = item;
                await db.collection(collection).doc(id).update(data);
                const idx = Store.data[collection].findIndex(x => x.id === id);
                if(idx !== -1) Store.data[collection][idx] = item;
            },

            async delete(collection, id) {
                await db.collection(collection).doc(id).delete();
                Store.data[collection] = Store.data[collection].filter(x => x.id !== id);
            },

            async uploadFile(file, path) {
                const ref = storage.ref(path);
                await ref.put(file);
                return await ref.getDownloadURL();
            }
        };

        const app = {
            initialized: false, // Flag para evitar carregar duas vezes
            tempBudgetItems: [],
            editingServiceId: null,
            editingComboId: null,
            editingClientId: null,
            editingScheduleId: null,
            currentProjectId: null,

            init() {
                Store.init();
                this.initialized = true;
            },

            renderAll() {
                this.renderServices();
                this.renderCombos();
                this.renderClients();
                this.renderBudgets();
                this.renderProjects();
                this.renderFinance();
                this.renderCalendar();
                this.renderDashboard();
                this.renderContracts();
            },

            navigate(id) {
                document.querySelectorAll('section').forEach(el => el.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
                event.currentTarget.classList.add('active');
            },

            showToast(msg) {
                const t = document.createElement('div');
                t.className = 'toast';
                t.innerHTML = `<i class="fas fa-check-circle" style="color:var(--success)"></i> ${msg}`;
                document.getElementById('toast-container').appendChild(t);
                setTimeout(() => t.remove(), 3000);
            },

            // --- SERVIÇOS ---
            openModalService(id = null) {
                this.editingServiceId = id;
                const s = id ? Store.data.services.find(x => x.id === id) : { name:'', unit:'video', price:0, description:'' };
                document.getElementById('service-name').value = s.name;
                document.getElementById('service-unit').value = s.unit;
                document.getElementById('service-price').value = s.price;
                document.getElementById('service-desc').value = s.description;
                this.openModal('modal-service');
            },
            async saveService(e) {
                e.preventDefault();
                const data = {
                    name: document.getElementById('service-name').value,
                    unit: document.getElementById('service-unit').value,
                    price: parseFloat(document.getElementById('service-price').value),
                    description: document.getElementById('service-desc').value
                };
                if(this.editingServiceId) {
                    await Store.update('services', this.editingServiceId, { ...data, id: this.editingServiceId });
                } else {
                    await Store.add('services', data);
                }
                this.closeModal('modal-service');
                this.renderServices();
                this.showToast('Serviço salvo');
            },
            async deleteService(id) {
                if(confirm('Excluir serviço?')) {
                    await Store.delete('services', id);
                    this.renderServices();
                    this.showToast('Excluído');
                }
            },
            renderServices() {
                const unitLabels = { 'hour': 'Hora', 'track': 'Faixa', 'image': 'Imagem', 'video': 'Vídeo' };
                document.querySelector('#table-services tbody').innerHTML = Store.data.services.map(s => `
                    <tr>
                        <td><strong>${s.name}</strong><br><small style="color:var(--text-secondary)">${s.description}</small></td>
                        <td>${unitLabels[s.unit] || s.unit}</td>
                        <td>${Utils.formatCurrency(s.price)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="app.openModalService('${s.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="app.deleteService('${s.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            // --- COMBOS ---
            openModalCombo(id = null) {
                this.editingComboId = id;
                const combo = id ? Store.data.combos.find(x => x.id === id) : { name:'', description:'', serviceIds:[] };
                document.getElementById('combo-name').value = combo.name;
                document.getElementById('combo-desc').value = combo.description;
                
                const list = document.getElementById('combo-services-list');
                list.innerHTML = Store.data.services.map(s => `
                    <div>
                        <input type="checkbox" class="combo-check" value="${s.id}" ${combo.serviceIds.includes(s.id) ? 'checked' : ''} onchange="app.updateComboPreview()">
                        <span>${s.name} (${Utils.formatCurrency(s.price)})</span>
                    </div>
                `).join('');
                
                this.updateComboPreview();
                this.openModal('modal-combo');
            },
            updateComboPreview() {
                const checks = document.querySelectorAll('.combo-check:checked');
                let total = 0;
                checks.forEach(c => {
                    const s = Store.data.services.find(srv => srv.id == c.value);
                    if(s) total += s.price;
                });
                document.getElementById('combo-preview-price').innerText = Utils.formatCurrency(total);
                return total;
            },
            async saveCombo(e) {
                e.preventDefault();
                const checks = document.querySelectorAll('.combo-check:checked');
                const serviceIds = Array.from(checks).map(c => c.value);
                const data = {
                    name: document.getElementById('combo-name').value,
                    description: document.getElementById('combo-desc').value,
                    serviceIds: serviceIds,
                    totalPrice: this.updateComboPreview()
                };
                if(this.editingComboId) {
                    await Store.update('combos', this.editingComboId, { ...data, id: this.editingComboId });
                } else {
                    await Store.add('combos', data);
                }
                this.closeModal('modal-combo');
                this.renderCombos();
                this.showToast('Pacote salvo');
            },
            async deleteCombo(id) {
                if(confirm('Excluir combo?')) {
                    await Store.delete('combos', id);
                    this.renderCombos();
                }
            },
            renderCombos() {
                document.querySelector('#table-combos tbody').innerHTML = Store.data.combos.map(c => {
                    const items = c.serviceIds.map(id => {
                        const s = Store.data.services.find(srv => srv.id === id);
                        return s ? s.name : 'Item removido';
                    }).join(', ');
                    return `
                        <tr>
                            <td><strong>${c.name}</strong><br><small>${c.description}</small></td>
                            <td>${items}</td>
                            <td>${Utils.formatCurrency(c.totalPrice)}</td>
                            <td>
                                <button class="btn btn-sm btn-outline" onclick="app.openModalCombo('${c.id}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="app.deleteCombo('${c.id}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            // --- CLIENTES ---
            prepareAddClient() {
                this.editingClientId = null;
                document.getElementById('modal-client-title').innerText = "Novo Cliente";
                document.querySelector('#modal-client form').reset();
                this.openModal('modal-client');
            },
            editClient(id) {
                this.editingClientId = id;
                const c = Store.data.clients.find(x => x.id === id);
                document.getElementById('modal-client-title').innerText = "Editar Cliente";
                document.getElementById('client-name').value = c.name;
                document.getElementById('client-type').value = c.type;
                document.getElementById('client-doc').value = c.doc;
                document.getElementById('client-email').value = c.email;
                document.getElementById('client-phone').value = c.phone;
                this.toggleClientDoc();
                this.openModal('modal-client');
            },
            async saveClient(e) {
                e.preventDefault();
                const data = {
                    type: document.getElementById('client-type').value,
                    name: document.getElementById('client-name').value,
                    doc: document.getElementById('client-doc').value,
                    email: document.getElementById('client-email').value,
                    phone: document.getElementById('client-phone').value,
                };
                if(this.editingClientId) {
                    await Store.update('clients', this.editingClientId, { ...data, id: this.editingClientId });
                    this.showToast('Cliente atualizado');
                } else {
                    await Store.add('clients', data);
                    this.showToast('Cliente cadastrado');
                }
                this.closeModal('modal-client');
                this.renderClients();
            },
            async deleteClient(id) {
                if(confirm('Excluir cliente?')) {
                    await Store.delete('clients', id);
                    this.renderClients();
                }
            },
            toggleClientDoc() {
                document.getElementById('label-doc').innerText = document.getElementById('client-type').value === 'pf' ? 'CPF' : 'CNPJ';
                document.getElementById('client-doc').value = '';
            },
            maskPhone(i) {
                let v = i.value.replace(/\D/g, "");
                v = v.replace(/^(\d\d)(\d)/g, "($1) $2");
                v = v.replace(/(\d{5})(\d)/, "$1-$2");
                i.value = v.substring(0, 15);
            },
            maskDocument(i) {
                const type = document.getElementById('client-type').value;
                let v = i.value.replace(/\D/g, "");
                if (type === 'pf') {
                    v = v.replace(/(\d{3})(\d)/, "$1.$2");
                    v = v.replace(/(\d{3})(\d)/, "$1.$2");
                    v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
                } else {
                    v = v.replace(/^(\d{2})(\d)/, "$1.$2");
                    v = v.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
                    v = v.replace(/\.(\d{3})(\d)/, ".$1/$2");
                    v = v.replace(/(\d{4})(\d)/, "$1-$2");
                }
                i.value = v;
            },
            renderClients() {
                document.querySelector('#table-clients tbody').innerHTML = Store.data.clients.map(c => `
                    <tr>
                        <td>${c.name}</td>
                        <td>${c.type==='pf'?'Física':'Jurídica'}</td>
                        <td>${c.doc}</td>
                        <td>${c.phone}</td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="app.editClient('${c.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="app.deleteClient('${c.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            // --- ORÇAMENTOS ---
            openModalBudget() {
                this.tempBudgetItems = [];
                document.querySelector('#modal-budget form').reset();
                document.getElementById('budget-items-tbody').innerHTML = '';
                document.getElementById('budget-final-val').innerText = 'R$ 0,00';
                document.getElementById('empty-budget-msg').style.display = 'block';
                
                const select = document.getElementById('budget-item-select');
                select.innerHTML = '';
                
                if(Store.data.services.length) {
                    select.innerHTML += `<optgroup label="Serviços Individuais">`;
                    Store.data.services.forEach(s => {
                        select.innerHTML += `<option value="service|${s.id}">${s.name} (${Utils.formatCurrency(s.price)})</option>`;
                    });
                    select.innerHTML += `</optgroup>`;
                }
                
                if(Store.data.combos.length) {
                    select.innerHTML += `<optgroup label="Pacotes (Combos)">`;
                    Store.data.combos.forEach(c => {
                        select.innerHTML += `<option value="combo|${c.id}">${c.name} - PACOTE (${Utils.formatCurrency(c.totalPrice)})</option>`;
                    });
                    select.innerHTML += `</optgroup>`;
                }

                const cSelect = document.getElementById('budget-client');
                cSelect.innerHTML = '<option value="">Selecione...</option>';
                Store.data.clients.forEach(c => cSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`);

                this.openModal('modal-budget');
            },

            addItemToBudget() {
                const val = document.getElementById('budget-item-select').value;
                if(!val) return;
                const [type, id] = val.split('|');
                
                let item = null;
                if(type === 'service') item = Store.data.services.find(x => x.id == id);
                if(type === 'combo') item = Store.data.combos.find(x => x.id == id);

                if(item) {
                    this.tempBudgetItems.push({
                        type: type,
                        id: item.id,
                        name: item.name,
                        price: item.price || item.totalPrice
                    });
                    this.renderBudgetItems();
                    this.calculateBudgetTotal();
                }
            },

            removeItemFromBudget(index) {
                this.tempBudgetItems.splice(index, 1);
                this.renderBudgetItems();
                this.calculateBudgetTotal();
            },

            renderBudgetItems() {
                const tbody = document.getElementById('budget-items-tbody');
                const msg = document.getElementById('empty-budget-msg');
                
                if(this.tempBudgetItems.length === 0) {
                    tbody.innerHTML = '';
                    msg.style.display = 'block';
                } else {
                    msg.style.display = 'none';
                    tbody.innerHTML = this.tempBudgetItems.map((item, idx) => `
                        <tr>
                            <td>${item.name} <span style="font-size:0.8em; opacity:0.7">(${item.type === 'combo' ? 'Combo' : 'Serviço'})</span></td>
                            <td>${Utils.formatCurrency(item.price)}</td>
                            <td><button type="button" class="btn btn-sm btn-danger" onclick="app.removeItemFromBudget(${idx})">&times;</button></td>
                        </tr>
                    `).join('');
                }
            },

            calculateBudgetTotal() {
                if(this.tempBudgetItems.length === 0) {
                    document.getElementById('budget-final-val').innerText = 'R$ 0,00';
                    return 0;
                }
                
                const subtotal = this.tempBudgetItems.reduce((acc, item) => acc + item.price, 0);
                const discType = document.getElementById('budget-discount-type').value;
                const discVal = parseFloat(document.getElementById('budget-discount-val').value) || 0;

                let final = subtotal;
                if(discType === 'perc') final = subtotal - (subtotal * (discVal / 100));
                else final = subtotal - discVal;

                if(final < 0) final = 0;
                document.getElementById('budget-final-val').innerText = Utils.formatCurrency(final);
                return final;
            },

            async saveBudget(e) {
                e.preventDefault();
                if(this.tempBudgetItems.length === 0) return alert('Adicione pelo menos um serviço ou combo.');

                const b = {
                    clientId: document.getElementById('budget-client').value,
                    clientName: Store.data.clients.find(c => c.id == document.getElementById('budget-client').value).name,
                    items: [...this.tempBudgetItems],
                    finalPrice: this.calculateBudgetTotal(),
                    status: 'pending',
                    notes: document.getElementById('budget-notes').value,
                    createdAt: new Date().toISOString()
                };
                
                await Store.add('budgets', b);
                this.closeModal('modal-budget');
                this.renderBudgets();
                this.showToast('Orçamento criado');
            },
            
            async deleteBudget(id) {
                if(confirm('Isso também excluirá o projeto vinculado. Continuar?')) {
                    const linkedProject = Store.data.projects.find(p => p.budgetId === id);
                    if(linkedProject) await Store.delete('projects', linkedProject.id);
                    
                    await Store.delete('budgets', id);
                    this.renderBudgets();
                }
            },
            
            async approveBudget(id) {
                const b = Store.data.budgets.find(x => x.id === id);
                if(b) {
                    await Store.update('budgets', id, { status: 'approved' });
                    b.status = 'approved';

                    const p = {
                        budgetId: b.id,
                        clientName: b.clientName,
                        service: b.items.length > 1 ? 'Pacote Misto' : b.items[0].name, 
                        status: 'not-started',
                        files: [], 
                        notes: b.notes
                    };
                    await Store.add('projects', p);
                    this.renderBudgets();
                    this.renderProjects();
                    this.showToast('Aprovado! Projeto criado.');
                }
            },

            sendWhatsapp(id) {
                const b = Store.data.budgets.find(bud => bud.id === id);
                const client = Store.data.clients.find(c => c.id == b.clientId);
                const msg = `Olá ${client.name}, segue o orçamento. Valor: ${Utils.formatCurrency(b.finalPrice)}.`;
                const url = `https://wa.me/55${client.phone.replace(/\D/g, '')}?text=${encodeURIComponent(msg)}`;
                window.open(url, '_blank');
            },

            printBudget(id) {
                const b = Store.data.budgets.find(bud => bud.id === id);
                const client = Store.data.clients.find(c => c.id == b.clientId);
                
                const itemsList = b.items.map(i => `<li>${i.name}: ${Utils.formatCurrency(i.price)}</li>`).join('');

                this.printDoc(`
                    <h2>Orçamento #${b.id.slice(-4)}</h2>
                    <p><strong>Cliente:</strong> ${client.name}</p>
                    <hr>
                    <ul>${itemsList}</ul>
                    <h3>Valor Total: ${Utils.formatCurrency(b.finalPrice)}</h3>
                    <p>${b.notes}</p>
                `);
            },

            renderBudgets() {
                const term = document.getElementById('search-budget')?.value?.toLowerCase() || '';
                const list = Store.data.budgets.filter(b => b.clientName.toLowerCase().includes(term) || b.id.toString().includes(term));
                
                document.querySelector('#table-budgets tbody').innerHTML = list.map(b => {
                    let summary = b.items.map(i => i.name).slice(0, 2).join(', ');
                    if(b.items.length > 2) summary += '...';

                    let actionBtns = '';
                    if(b.status === 'pending') {
                        actionBtns = `<button class="btn btn-sm btn-success" onclick="app.approveBudget('${b.id}')">Aprovar</button>`;
                    } else {
                        actionBtns = `
                            <button class="btn btn-sm btn-outline" onclick="app.sendWhatsapp('${b.id}')"><i class="fab fa-whatsapp"></i></button>
                            <button class="btn btn-sm btn-outline" onclick="app.printBudget('${b.id}')"><i class="fas fa-file-pdf"></i></button>
                            <button class="btn btn-sm btn-outline" onclick="app.generateContract('${b.id}')"><i class="fas fa-file-signature"></i></button>
                            <button class="btn btn-sm btn-outline" onclick="app.openProjectFromBudget('${b.id}')"><i class="fas fa-folder-open"></i></button>
                            <button class="btn btn-sm btn-primary" onclick="app.generateReceiptFromBudget('${b.id}')"><i class="fas fa-receipt"></i></button>
                        `;
                    }

                    return `
                        <tr>
                            <td>#${b.id.slice(-4)}</td>
                            <td>${b.clientName}</td>
                            <td>${summary}</td>
                            <td>${Utils.formatCurrency(b.finalPrice)}</td>
                            <td><span class="badge ${b.status==='approved'?'badge-approved':'badge-pending'}">${b.status==='approved'?'Aprovado':'Pendente'}</span></td>
                            <td>
                                <div style="display:flex; gap:5px; flex-wrap:wrap;">${actionBtns}</div>
                                <button class="btn btn-sm btn-danger" onclick="app.deleteBudget('${b.id}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            // --- PROJETOS ---
            openProjectDetails(id) {
                this.currentProjectId = id;
                const p = Store.data.projects.find(x => x.id === id);
                const content = document.getElementById('project-details-content');
                
                const filesHtml = p.files.map(f => `
                    <div style="background:var(--bg-body); padding:8px; border-radius:4px; margin-bottom:5px; display:flex; justify-content:space-between; align-items:center;">
                        <a href="${f.url}" target="_blank" style="color:var(--primary); text-decoration:none; font-size:0.9rem;"><i class="fas fa-link"></i> ${f.name}</a>
                        <button class="btn btn-sm btn-danger" style="padding:2px 6px;" onclick="app.removeProjectFile('${f.id}')"><i class="fas fa-times"></i></button>
                    </div>
                `).join('');

                content.innerHTML = `
                    <div class="form-group">
                        <label>Status</label>
                        <select id="p-status" onchange="app.updateProjectStatus()">
                            <option value="not-started" ${p.status==='not-started'?'selected':''}>Não Iniciado</option>
                            <option value="in-progress" ${p.status==='in-progress'?'selected':''}>Em Andamento</option>
                            <option value="completed" ${p.status==='completed'?'selected':''}>Concluído</option>
                            <option value="cancelled" ${p.status==='cancelled'?'selected':''}>Cancelado</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Notas</label><textarea id="p-notes">${p.notes || ''}</textarea></div>
                    
                    <hr style="border-color:var(--border); margin:20px 0;">
                    <h4><i class="fas fa-cloud-upload-alt"></i> Armazenamento (Firebase)</h4>
                    
                    <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
                        <input type="file" id="file-input" style="flex:2; font-size:0.8rem;">
                        <button class="btn btn-sm btn-primary" id="btn-upload-file" onclick="app.addProjectFile()">Enviar</button>
                    </div>
                    
                    <div id="project-file-list">${filesHtml.length ? filesHtml : '<small>Nenhum arquivo.</small>'}</div>

                    <div style="margin-top:30px; text-align:right;">
                        <button class="btn btn-danger" onclick="app.deleteProject('${p.id}')">Excluir Projeto</button>
                        <button class="btn btn-primary" onclick="app.saveProjectDetails()">Salvar</button>
                    </div>
                `;
                this.openModal('modal-project-details');
            },
            
            async addProjectFile() {
                const fileInput = document.getElementById('file-input');
                const btn = document.getElementById('btn-upload-file');
                
                if(!fileInput.files[0]) return alert('Selecione um arquivo');

                const file = fileInput.files[0];
                const path = `projects/${this.currentProjectId}/${Date.now()}_${file.name}`;
                
                btn.disabled = true;
                btn.innerText = "Enviando...";
                
                try {
                    const url = await Store.uploadFile(file, path);
                    const p = Store.data.projects.find(x => x.id === this.currentProjectId);
                    p.files.push({ id: Utils.generateId(), name: file.name, url: url });
                    await Store.update('projects', this.currentProjectId, p);
                    
                    this.openProjectDetails(this.currentProjectId); // Re-render
                } catch (error) {
                    alert('Erro ao fazer upload: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerText = "Enviar";
                }
            },

            async removeProjectFile(fileId) {
                if(confirm('Remover referência do arquivo?')) {
                    const p = Store.data.projects.find(x => x.id === this.currentProjectId);
                    p.files = p.files.filter(f => f.id !== fileId);
                    await Store.update('projects', this.currentProjectId, p);
                    this.openProjectDetails(this.currentProjectId);
                }
            },
            
            async updateProjectStatus() {
                const p = Store.data.projects.find(x => x.id === this.currentProjectId);
                const status = document.getElementById('p-status').value;
                await Store.update('projects', this.currentProjectId, { status });
                this.renderProjects();
            },
            
            async deleteProject(id) {
                if(confirm('Excluir projeto?')) {
                    await Store.delete('projects', id);
                    this.closeModal('modal-project-details');
                    this.renderProjects();
                }
            },
            
            async saveProjectDetails() {
                const p = Store.data.projects.find(x => x.id === this.currentProjectId);
                await Store.update('projects', this.currentProjectId, { notes: document.getElementById('p-notes').value });
                this.closeModal('modal-project-details');
                this.showToast('Projeto atualizado');
            },
            
            renderProjects() {
                const cols = { 'not-started':[], 'in-progress':[], 'completed':[], 'cancelled':[] };
                Store.data.projects.forEach(p => { if(cols[p.status]) cols[p.status].push(p); });
                
                for(let k in cols) {
                    document.getElementById(`list-${k}`).innerHTML = cols[k].map(p => `
                        <div class="project-card" onclick="app.openProjectDetails('${p.id}')">
                            <h4>${p.service}</h4>
                            <p>${p.clientName}</p>
                            ${p.files.length ? `<small style="color:var(--primary)"><i class="fas fa-paperclip"></i> ${p.files.length}</small>` : ''}
                        </div>
                    `).join('');
                    document.getElementById(`count-${k}`).innerText = cols[k].length;
                }
            },
            
            openProjectFromBudget(budgetId) {
                const p = Store.data.projects.find(proj => proj.budgetId === budgetId);
                if(p) {
                    this.navigate('projects');
                    setTimeout(() => this.openProjectDetails(p.id), 100);
                }
            },

            // --- FINANCEIRO ---
            async saveTransaction(e) {
                e.preventDefault();
                const t = {
                    type: document.getElementById('trans-type').value,
                    clientId: document.getElementById('trans-client').value || null,
                    desc: document.getElementById('trans-desc').value,
                    category: document.getElementById('trans-cat').value,
                    val: parseFloat(document.getElementById('trans-val').value),
                    date: new Date().toISOString().split('T')[0]
                };
                await Store.add('transactions', t);
                this.closeModal('modal-transaction');
                this.renderFinance();
                this.showToast('Transação salva');
            },
            async deleteTransaction(id) {
                await Store.delete('transactions', id);
                this.renderFinance();
            },
            async generateReceiptFromBudget(budgetId) {
                const b = Store.data.budgets.find(x => x.id === budgetId);
                if(confirm('Gerar recibo e baixar entrada no caixa?')) {
                    await Store.add('transactions', {
                        type: 'in',
                        clientId: b.clientId,
                        category: 'Pagamento de Serviço',
                        desc: `Recibo #${b.id}`,
                        val: b.finalPrice,
                        date: new Date().toISOString().split('T')[0]
                    });
                    this.printDoc(`<h1>RECIBO</h1><p>Recebemos de <strong>${b.clientName}</strong></p><p>A quantia de <strong>${Utils.formatCurrency(b.finalPrice)}</strong></p>`);
                    this.renderFinance();
                }
            },
            renderFinance() {
                const tbody = document.querySelector('#table-transactions tbody');
                const list = [...Store.data.transactions].sort((a,b) => new Date(b.date)-new Date(a.date));
                let totIn = 0, totOut = 0;

                tbody.innerHTML = list.map(t => {
                    if(t.type === 'in') totIn += t.val; else totOut += t.val;
                    const clientName = t.clientId ? Store.data.clients.find(c => c.id == t.clientId)?.name || '' : '';
                    const displayDesc = clientName ? `${clientName} - ${t.desc}` : t.desc;
                    
                    return `
                        <tr>
                            <td>${Utils.formatDate(t.date)}</td>
                            <td>${displayDesc}</td>
                            <td>${t.category}</td>
                            <td style="color:${t.type==='in'?'var(--success)':'var(--danger)'}">${Utils.formatCurrency(t.val)}</td>
                            <td><button class="btn btn-sm btn-danger" onclick="app.deleteTransaction('${t.id}')"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    `;
                }).join('');

                const balance = totIn - totOut;
                document.getElementById('fin-total-in').innerText = Utils.formatCurrency(totIn);
                document.getElementById('fin-total-out').innerText = Utils.formatCurrency(totOut);
                document.getElementById('fin-balance').innerText = Utils.formatCurrency(balance);
                
                document.getElementById('mei-cash-avail').value = Utils.formatCurrency(balance);
                this.updateWithdrawal();
            },
            updateWithdrawal() {
                const cashStr = document.getElementById('mei-cash-avail').value;
                const cash = Utils.parseCurrency(cashStr);
                const perc = parseFloat(document.getElementById('mei-perc').value) || 0;
                document.getElementById('mei-withdrawal-val').innerText = Utils.formatCurrency(cash * (perc/100));
            },

            // --- AGENDA ---
            changeMonth(delta) {
                Store.currentDate.setMonth(Store.currentDate.getMonth() + delta);
                this.renderCalendar();
            },
            renderCalendar() {
                const year = Store.currentDate.getFullYear();
                const month = Store.currentDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                document.getElementById('cal-month-year').innerText = `${monthNames[month]} ${year}`;

                const grid = document.getElementById('cal-days');
                grid.innerHTML = '';
                for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
                for(let i=1; i<=daysInMonth; i++) {
                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const events = Store.data.schedules.filter(s => s.date === dateStr);
                    const isToday = new Date().toISOString().split('T')[0] === dateStr;
                    let eventDots = events.map(e => `<div class="cal-event-dot">${e.service}</div>`).join('');
                    grid.innerHTML += `<div class="cal-day ${isToday?'today':''}" onclick="app.selectDate('${dateStr}')"><div class="cal-day-number">${i}</div>${eventDots}</div>`;
                }

                const futureEvents = Store.data.schedules.filter(s => s.date >= new Date().toISOString().split('T')[0]).sort((a,b) => new Date(a.date) - new Date(b.date));
                document.getElementById('schedule-list').innerHTML = futureEvents.length ? futureEvents.map(s => `
                    <div style="border-bottom:1px solid var(--border); padding:10px; display:flex; justify-content:space-between; align-items:center;">
                        <div><strong>${Utils.formatDate(s.date)}</strong> - ${s.service}<br><small>${Store.data.clients.find(c=>c.id==s.clientId)?.name}</small></div>
                        <div style="display:flex; gap:5px;">
                            <button class="btn btn-sm btn-outline" onclick="app.editSchedule('${s.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="app.deleteSchedule('${s.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('') : '<p>Sem eventos futuros.</p>';
            },
            selectDate(dateStr) {
                this.editingScheduleId = null;
                document.getElementById('sched-modal-title').innerText = "Novo Agendamento";
                document.querySelector('#modal-schedule form').reset();
                this.openModal('modal-schedule');
                setTimeout(() => document.getElementById('sched-date').value = dateStr, 100);
            },
            editSchedule(id) {
                this.editingScheduleId = id;
                const s = Store.data.schedules.find(x => x.id === id);
                document.getElementById('sched-modal-title').innerText = "Editar Agendamento";
                document.getElementById('sched-client').value = s.clientId;
                document.getElementById('sched-service').value = s.service;
                document.getElementById('sched-date').value = s.date;
                document.getElementById('sched-time').value = s.time;
                document.getElementById('sched-duration').value = s.duration;
                this.openModal('modal-schedule');
            },
            async saveSchedule(e) {
                e.preventDefault();
                const data = {
                    clientId: document.getElementById('sched-client').value,
                    service: document.getElementById('sched-service').value,
                    date: document.getElementById('sched-date').value,
                    time: document.getElementById('sched-time').value,
                    duration: document.getElementById('sched-duration').value
                };
                if(this.editingScheduleId) {
                    await Store.update('schedules', this.editingScheduleId, { ...data, id: this.editingScheduleId });
                    this.showToast('Agendamento atualizado');
                } else {
                    await Store.add('schedules', data);
                    this.showToast('Agendado');
                }
                this.closeModal('modal-schedule');
                this.renderCalendar();
            },
            async deleteSchedule(id) {
                if(confirm('Excluir agendamento?')) {
                    await Store.delete('schedules', id);
                    this.renderCalendar();
                }
            },

            // --- DASHBOARD & DIVERSOS ---
            renderDashboard() {
                document.getElementById('dash-active-projects').innerText = Store.data.projects.filter(p => p.status==='in-progress').length;
                document.getElementById('dash-pending-budgets').innerText = Store.data.budgets.filter(b => b.status==='pending').length;
                const currentMonth = new Date().toISOString().slice(0, 7);
                const revenue = Store.data.transactions.filter(t => t.type === 'in' && t.date.startsWith(currentMonth)).reduce((acc, t) => acc + t.val, 0);
                document.getElementById('dash-revenue').innerText = Utils.formatCurrency(revenue);
            },
            generateContract(id) {
                const b = Store.data.budgets.find(bud => bud.id === id);
                const client = Store.data.clients.find(c => c.id == b.clientId);
                this.printDoc(`<h2>CONTRATO</h2><p><strong>CONTRATANTE:</strong> ${client.name}</p><p><strong>SERVIÇO:</strong> ${b.items.map(i=>i.name).join(', ')}</p><p><strong>VALOR:</strong> ${Utils.formatCurrency(b.finalPrice)}</p><br><br><p>______________________</p><p>Assinatura</p>`);
            },
            renderContracts() {
                const approved = Store.data.budgets.filter(b => b.status === 'approved');
                document.querySelector('#table-contracts tbody').innerHTML = approved.map(b => `
                    <tr><td>${b.items.map(i=>i.name).join(', ')}</td><td>${b.clientName}</td><td><button class="btn btn-sm btn-outline" onclick="app.generateContract('${b.id}')">Baixar</button></td></tr>
                `).join('');
            },
            
            // --- MODAL GERAL ---
            openModal(id, extra=null) {
                document.getElementById(id).classList.add('open');
                ['budget-client', 'sched-client', 'trans-client'].forEach(selId => {
                    const sel = document.getElementById(selId);
                    if(sel) {
                        sel.innerHTML = '<option value="">Selecione...</option>';
                        Store.data.clients.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name}</option>`);
                    }
                });
                
                if(id === 'modal-transaction') {
                    document.getElementById('trans-type').value = extra;
                    document.getElementById('trans-title').innerText = extra==='in'?'Nova Receita':'Nova Despesa';
                    const catSel = document.getElementById('trans-cat');
                    const cats = extra==='in' ? ['Venda Serviço', 'Outros'] : ['Equipamento', 'Alimentação', 'Imposto', 'Pró-labore'];
                    catSel.innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
                }
            },
            closeModal(id) { document.getElementById(id).classList.remove('open'); },
            printDoc(html) {
                const area = document.getElementById('print-area');
                area.innerHTML = html;
                area.style.display = 'block';
                window.print();
                area.style.display = 'none';
            }
        };

        // Configuração da Senha e Inicialização
        const MINHA_SENHA_SECRETA = "9107"; 

        function checkPassword() {
            const input = document.getElementById('pass-input').value;
            
            if(input === MINHA_SENHA_SECRETA) {
                // Remove a trava correta e inicia o sistema
                document.getElementById('lock-screen').style.display = 'none';
                
                // Remove apenas o estilo de trava pelo ID
                const lockStyle = document.getElementById('lock-css');
                if(lockStyle) lockStyle.remove();
                
                // Força o app a iniciar normalmente (apenas uma vez)
                if (!app.initialized) {
                    app.init();
                } 
            } else {
                alert('Senha incorreta!');
            }
        }

        // Permite apertar Enter para logar
        document.getElementById('pass-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // Inicialização de Scripts (Service Worker)
        document.addEventListener('DOMContentLoaded', () => {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker Registrado'))
                .catch(err => console.log('Service Worker: erro', err));
            }
        });
    </script>
</body>
</html>